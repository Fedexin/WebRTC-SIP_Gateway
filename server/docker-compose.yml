version: "3.8"

services:
  rtpengine:
    image: drachtio/rtpengine:latest
    container_name: rtpengine-sip-webrtc
    ports:
      - "22222:22222/udp" # NG protocol
      - "8090:8080/tcp" # HTTP interface
      - "10000-10500:10000-10500/udp" # RTP media ports
    cap_add:
      - NET_ADMIN
    environment:
      # âœ… FIX: Interface configuration
      - INTERFACE=private/172.17.0.2!192.168.1.209
      # Formato: internal_ip!public_ip
      # 172.17.0.2 = IP del container (Docker default bridge)
      # 192.168.1.209 = IP pubblico del Mac sulla LAN

      - PORT_MIN=10000
      - PORT_MAX=10500
      - LISTEN_NG=22222:0.0.0.0
      - LISTEN_CLI=9901:127.0.0.1
      - LISTEN_HTTP=8080:0.0.0.0
      - LOG_LEVEL=7
      - TOS=184
      - RECORDING_METHOD=pcap
      - RECORDING_DIR=/tmp/recordings
    volumes:
      - rtpengine-recordings:/tmp/recordings
      - /proc:/proc # Richiesto per kernel module
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  rtpengine-recordings:
    driver: local
